#!/bin/echo
# vim: ft=sh

has() {
  which "$1" >/dev/null 2>&1
  return $?
}

# TODO: replace .. in paths
abspath() {
  if [ "${1#/}" = "$1" ]; then
    echo $PWD/$1
  else
    echo $1
  fi
}

# Safer PATH handling
PATH_add() {
  export PATH="`abspath "$1"`:$PATH"
}

layout_ruby() {
  # TODO: ruby_version should be the ABI version
  _ruby_version=`ruby -e"puts (defined?(RUBY_ENGINE) ? RUBY_ENGINE : 'ruby') + '-' + RUBY_VERSION"`
  PATH_add ".direnv/${_ruby_version}/bin"
  PATH_add "bin"
  export RUBYLIB=$PWD/lib
  export GEM_HOME=$PWD/.direnv/${_ruby_version}
  export RBXOPT=-Xrbc.db=$PWD/.direnv/rbx-cache
}

layout() {
  eval "layout_$1"
}

# This folder contains a <program-name>/<version> structure
cellar_path=/usr/local/Cellar
set_cellar_path() {
  cellar_path=$1
}

# $1: program name
# $2: wanted version
use() {
  path="$cellar_path/$1/$2/bin"
  if [ -d "$path" ]; then
    echo "Using $1 v$2"
    PATH_add "$path"
  else
    echo "* Unable to load $path"
  fi
  unset path
}

set_program_prefix() {
  echo '`set_program_prefix` was renamed to `set_cellar_path`'
}

add_program() {
  echo '`add_program` does not exist anymore and was replaced by `use`'
}

# Inherit another .envrc
source_env() {
  rcfile=$1
  if [ -d "$1" ]; then
    rcfile=$1/.envrc
  fi
  echo "direnv: loading $rcfile"
  pushd `dirname "$rcfile"` > /dev/null
  . ./`basename "$rcfile"`
  popd > /dev/null
  unset rcfile
}

if [ -n "$rvm_path" ]; then
  # source rvm on first call, haha :)
  rvm() {
    unset rvm
    set +e
    . "$rvm_path/scripts/rvm"
    rvm $@
    set -e
  }
fi
